services:
  db:
    image: mysql:8.0
    container_name: shs-voice-ai-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: voice_ai
      MYSQL_USER: voice_ai_user
      MYSQL_PASSWORD: ${DB_PASSWORD:-voiceaipassword}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootpassword}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - voice-ai-network
    restart: unless-stopped

  voice-ai:
    build: .
    container_name: shs-voice-ai
    ports:
      - "8000:8000"
    env_file:
      - app/.env
    environment:
      # Database connection for Docker (uses service name as host)
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USER=voice_ai_user
      - DB_PASSWORD=${DB_PASSWORD:-voiceaipassword}
      - DB_NAME=voice_ai
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - voice-ai-network
    restart: unless-stopped

  # Ngrok tunnel for public URL
  ngrok:
    image: ngrok/ngrok:latest
    container_name: shs-ngrok
    env_file:
      - app/.env
    command: http voice-ai:8000 --log stdout
    ports:
      - "4040:4040"
    networks:
      - voice-ai-network
    depends_on:
      - voice-ai
    restart: unless-stopped

  # Auto-configure Twilio webhook with ngrok URL
  twilio-config:
    image: curlimages/curl:latest
    container_name: shs-twilio-config
    env_file:
      - app/.env
    depends_on:
      - ngrok
      - voice-ai
    networks:
      - voice-ai-network
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo ""
        echo "============================================"
        echo "üöÄ Sears Voice Agent - Auto Configuration"
        echo "============================================"
        echo ""
        echo "‚è≥ Waiting for ngrok to initialize..."
        sleep 15
        
        echo "üîç Fetching ngrok public URL..."
        for i in 1 2 3 4 5; do
          NGROK_URL=$$(curl -s http://ngrok:4040/api/tunnels 2>/dev/null | grep -o '"public_url":"https://[^"]*' | head -1 | cut -d'"' -f4)
          if [ -n "$$NGROK_URL" ]; then
            break
          fi
          echo "   Retry $$i/5..."
          sleep 5
        done
        
        if [ -z "$$NGROK_URL" ]; then
          echo "‚ùå ERROR: Failed to get ngrok URL after 5 attempts"
          echo "   Check if NGROK_AUTHTOKEN is set correctly in .env"
          exit 1
        fi
        
        echo "‚úÖ ngrok URL: $$NGROK_URL"
        echo ""
        echo "üìû Updating Twilio webhook configuration..."
        
        RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST \
          "https://api.twilio.com/2010-04-01/Accounts/$${TWILIO_ACCOUNT_SID}/IncomingPhoneNumbers/$${TWILIO_PHONE_NUMBER_SID}.json" \
          -u "$${TWILIO_ACCOUNT_SID}:$${TWILIO_AUTH_TOKEN}" \
          -d "VoiceUrl=$${NGROK_URL}/twilio/voice" \
          -d "VoiceMethod=POST")
        
        HTTP_CODE=$$(echo "$$RESPONSE" | tail -1)
        
        if [ "$$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Twilio webhook updated successfully!"
          echo ""
          echo "============================================"
          echo "üéâ SYSTEM READY!"
          echo "============================================"
          echo ""
          echo "üì± Voice Webhook: $${NGROK_URL}/twilio/voice"
          echo "üñºÔ∏è  Upload Page:   $${NGROK_URL}/upload/{token}"
          echo "üìä ngrok Dashboard: http://localhost:4040"
          echo "üè• Health Check:   http://localhost:8000/health"
          echo ""
          echo "üìû Call your Twilio number to test!"
          echo "============================================"
        else
          echo "‚ùå ERROR: Failed to update Twilio webhook (HTTP $$HTTP_CODE)"
          echo "   Response: $$(echo "$$RESPONSE" | head -n -1)"
          echo ""
          echo "   Check your Twilio credentials in .env:"
          echo "   - TWILIO_ACCOUNT_SID"
          echo "   - TWILIO_AUTH_TOKEN"
          echo "   - TWILIO_PHONE_NUMBER_SID"
          exit 1
        fi

networks:
  voice-ai-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
